version: '3.8'

services:
  # Video Processing Worker
  video-processor:
    image: node:20-alpine
    container_name: pishro-video-processor
    working_dir: /app
    command: sh -c "npm install && npx tsx scripts/video-processor-worker.ts"

    volumes:
      # Ù¾Ø±ÙˆÚ˜Ù‡
      - .:/app
      # node_modules cache
      - video_processor_node_modules:/app/node_modules
      # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª Ù¾Ø±Ø¯Ø§Ø²Ø´
      - video_temp:/tmp/video-processing

    environment:
      # Database
      - DATABASE_URL=${DATABASE_URL}

      # Object Storage (iranServer S3)
      - S3_ENDPOINT=${S3_ENDPOINT}
      - S3_REGION=${S3_REGION:-default}
      - S3_ACCESS_KEY_ID=${S3_ACCESS_KEY_ID}
      - S3_SECRET_ACCESS_KEY=${S3_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - S3_PUBLIC_URL=${S3_PUBLIC_URL}

      # Temp directory
      - TEMP_DIR=/tmp/video-processing

      # Node
      - NODE_ENV=${NODE_ENV:-production}

    # Ù†ØµØ¨ FFmpeg Ø¯Ø± alpine
    entrypoint: |
      sh -c "
        echo 'ğŸ“¦ Installing FFmpeg...'
        apk add --no-cache ffmpeg
        echo 'âœ… FFmpeg installed'
        echo 'ğŸš€ Starting video processor worker...'
        npm install
        npx tsx scripts/video-processor-worker.ts
      "

    restart: unless-stopped

    # Resource limits (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 512M

    networks:
      - pishro-network

    # Health check
    healthcheck:
      test: ["CMD", "node", "--version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  video_processor_node_modules:
    driver: local
  video_temp:
    driver: local

networks:
  pishro-network:
    driver: bridge
