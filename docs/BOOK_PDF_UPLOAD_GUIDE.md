# سیستم آپلود PDF برای کتاب‌های دیجیتالی

## خلاصه

این فیچر به ادمین‌ها امکان می‌دهد تا فایل‌های PDF کتاب‌های دیجیتالی را مستقیماً از پنل ادمین آپلود کنند. فایل‌های آپلود شده بر روی سرور ذخیره می‌شوند و URL آن‌ها در دیتابیس ذخیره می‌شود.

## ساختار فنی

### 1. API اندپوینت
**مسیر:** `/api/admin/books/upload-pdf`
**روش:** `POST`
**نوع:** `multipart/form-data`

#### درخواست (Request)
```
POST /api/admin/books/upload-pdf
Content-Type: multipart/form-data

Body:
- pdf: File (الزامی) - فایل PDF
```

#### پاسخ موفق (200 OK)
```json
{
  "success": true,
  "message": "فایل PDF با موفقیت آپلود شد",
  "data": {
    "fileName": "original-name.pdf",
    "fileUrl": "/uploads/books/pdfs/book_1702876543210_abc123.pdf",
    "fileSize": 5242880,
    "mimeType": "application/pdf",
    "uploadedAt": "2024-12-18T10:30:00.000Z"
  }
}
```

#### خطاهای ممکن
| کد | پیام | علت |
|---|---|---|
| 401 | لطفاً وارد حساب کاربری خود شوید | کاربر وارد نشده است |
| 403 | دسترسی غیرمجاز - فقط ادمین | کاربر ادمین نیست |
| 400 | فایل PDF الزامی است | فایل ارسال نشده است |
| 400 | فقط فایل‌های PDF مجاز هستند | فایل PDF نیست |
| 400 | حجم فایل نباید بیشتر از 100 مگابایت باشد | حجم فایل بزرگ است |

### 2. سرویس آپلود (Client-side)
**فایل:** `@/lib/services/book-pdf-service.ts`

#### توابع اصلی:

##### `uploadBookPdf(file: File): Promise<UploadPdfResponse>`
آپلود فایل PDF و برگرداندن URL

**پارامترها:**
- `file` - فایل PDF

**برگردان:**
```typescript
{
  fileName: string;
  fileUrl: string;
  fileSize: number;
  mimeType: string;
  uploadedAt: string;
}
```

**خطاها:**
- اگر فایل PDF نباشد
- اگر حجم بزرگتر از 100MB باشد
- اگر پسوند فایل `.pdf` نباشد

### 3. کامپوننت BookForm
**فایل:** `@/components/Books/BookForm.tsx`

#### تغییرات:

1. **import سرویس:**
```typescript
import { uploadBookPdf } from "@/lib/services/book-pdf-service";
```

2. **State های جدید:**
```typescript
const [uploadingPdf, setUploadingPdf] = useState(false);
const [pdfFileName, setPdfFileName] = useState<string>("");
```

3. **Handlers:**
- `handlePdfUpload()` - مدیریت انتخاب و آپلود فایل PDF
- `handleRemovePdf()` - حذف فایل PDF انتخاب شده

4. **UI Components:**
- فیلد readonly برای نمایش URL فایل آپلود شده
- دکمه حذف فایل
- درپ‌زون برای انتخاب فایل PDF
- نمایش پیام موفقیت و خطا

## نحوه استفاده

### در پنل ادمین:

1. به قسمت "افزودن کتاب جدید" یا "ویرایش کتاب" بروید
2. در بخش "لینک فایل PDF" یکی از دو کار را انجام دهید:
   - روی دکمه "کلیک برای انتخاب PDF" کلیک کنید و فایل را انتخاب کنید
   - فایل PDF را دراگ کنید (اختیاری)
3. منتظر بمانید تا پیام "فایل PDF با موفقیت آپلود شد" نمایش یابد
4. URL فایل به‌طور خودکار در فیلد "لینک فایل PDF" پر می‌شود
5. فرم را با کلیک بر روی دکمه "ذخیره" ذخیره کنید

### حذف فایل:
اگر می‌خواهید فایل آپلود شده را تغییر دهید:
1. روی دکمه "✕" کلیک کنید
2. فایل جدیدی را انتخاب کنید
3. منتظر بمانید تا آپلود تکمیل شود

## محدودیت‌ها و محدودیت‌های امنیتی

| محدودیت | مقدار |
|----------|--------|
| حداکثر حجم فایل | 100 MB |
| فرمت‌های مجاز | PDF فقط |
| نیاز احراز هویت | بله (فقط ادمین) |
| محل ذخیره | `public/uploads/books/pdfs/` |
| نام‌گذاری فایل | `book_[timestamp]_[random].pdf` |

## ساختار پوشه‌ها

```
public/
├── uploads/
│   ├── books/
│   │   └── pdfs/
│   │       ├── book_1702876543210_abc123.pdf
│   │       ├── book_1702876543211_def456.pdf
│   │       └── ...
│   ├── videos/
│   └── ...
```

## مثال کامل

### 1. فرم کتاب جدید
ادمین وارد "افزودن کتاب جدید" می‌شود و فایل PDF را انتخاب می‌کند.

### 2. فرایند آپلود
- کاربر فایل PDF را انتخاب می‌کند
- فایل بلافاصله آپلود می‌شود (بدون نیاز به کلیک دکمه دوم)
- در حین آپلود، دکمه غیرفعال و برچسب "در حال آپلود..." نمایش داده می‌شود
- پس از تکمیل، URL در فیلد `fileUrl` پر می‌شود

### 3. ذخیره در دیتابیس
- زمانی که ادمین روی "ذخیره" کلیک می‌کند، کل فرم کتاب (شامل fileUrl) به سرور ارسال می‌شود
- فایل PDF در دیتابیس ذخیره می‌شود

## توابع API (Backend)

### فایل: `@/app/api/admin/books/upload-pdf/route.ts`

```typescript
// POST /api/admin/books/upload-pdf
// مقدار بازگشتی: UploadPdfResponse
```

### ویژگی‌ها:
- ✓ اعتبارسنجی احراز هویت و نقش
- ✓ اعتبارسنجی نوع فایل
- ✓ اعتبارسنجی حجم فایل
- ✓ نام‌گذاری منحصر به فرد برای جلوگیری از برخورد
- ✓ ایجاد خودکار پوشه‌ها
- ✓ بازگرداندن URL برای استفاده در فرم

## نکات مهم

1. **حفاظت در برابر هکرها:**
   - فقط ادمین‌ها می‌توانند فایل آپلود کنند
   - تنها فایل‌های PDF پذیرفته می‌شود
   - نام فایل تصادفی می‌شود

2. **عملکرد:**
   - آپلود بلافاصله پس از انتخاب فایل شروع می‌شود
   - نیازی به کلیک دکمه جداگانه نیست

3. **تجربه کاربر:**
   - پیام‌های واضح برای موفقیت و خطا
   - نمایش نام فایل اصلی بعد از آپلود
   - امکان تغییر یا حذف فایل

## troubleshooting

### مشکل: "خطا در آپلود فایل PDF"
**حل:**
- اطمینان حاصل کنید که فایل PDF است
- اطمینان حاصل کنید که حجم فایل کمتر از 100MB است
- مرورگر را بازآپی کنید
- کنسول مرورگر را بررسی کنید

### مشکل: فایل آپلود نشد اما خطایی نشان نداده شد
**حل:**
- اتصال اینترنت را بررسی کنید
- دوباره تلاش کنید
- از فایل دیگری استفاده کنید

### مشکل: فایل آپلود شد اما URL خالی است
**حل:**
- صفحه را تازه کنید
- دوباره لاگ‌ آن شنید

## آینده (بهبودهای ممکن)

1. **سپری‌سازی کلود:**
   - کمپرس کردن PDF
   - تبدیل PDF به فرمت‌های دیگر

2. **بهبود UI:**
   - پیشنمایش مختصر PDF
   - نمایش درصد آپلود
   - تاریخچه آپلودهای اخیر

3. **بهبود امنیتی:**
   - اسکن ویروس
   - رمزنگاری فایل

4. **بهبود عملکرد:**
   - آپلود قطعه‌ای (chunked upload) برای فایل‌های بزرگ
   - retry خودکار برای آپلودهای ناموفق

## تماس‌گیری (Support)

برای مسائل یا پیشنهادات:
1. Log file را بررسی کنید
2. console errors را نوشته کنید
3. فایل پیشنهاد ایجاد کنید
